<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard – Questionnaire Insights</title>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <style>
    :root {
      --primary: #021640;
      --c2: #0066cc;
      --c3: #0099cc;
      --c4: #4572c4;
      --c5: #558ed5;
      --c6: #1f4e79;
      --accent1: #ff7a8a;
      --accent2: #ffb347;
      --accent3: #8e44ad;
      --accent4: #27ae60;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6fb;
      color: var(--primary);
    }

    .header {
      background: #021640;
      color: #ffffff;
      text-align: center;
      padding: 18px 16px 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 1px;
    }

    .header p {
      margin: 3px 0 0;
      font-size: 13px;
      opacity: 0.85;
    }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 24px 40px;
    }

    /* Top nav */
    .top-nav {
      margin: 10px auto 0;
      max-width: 900px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-nav button {
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      background: #ffffff;
      color: #021640;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .top-nav button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background: #f2f4ff;
    }

    .top-nav button i { font-size: 14px; }

    /* KPI cards */
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin-top: 18px;
      justify-content: center;
    }

    .kpi-card {
      width: 260px;
      height: 95px;
      background: #ffffff;
      box-shadow: var(--card-shadow);
      border-radius: 14px;
      padding: 9px 13px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: var(--primary);
      border: 1px solid #e3e7f5;
    }

    .kpi-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 600;
    }

    .kpi-header i {
      font-size: 16px;
      color: #4572c4;
    }

    .kpi-value {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
      color: #021640;
    }

    .note {
      margin-top: 10px;
      font-size: 11px;
      color: #555;
    }

    /* Q4 summary */
    .q4-summary {
      margin-top: 14px;
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 14px 14px;
      box-shadow: var(--card-shadow);
      border: 1px solid #e3e7f5;
    }

    .q4-summary-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .q4-summary-caption {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
    }

    .q4-chart {
      width: 100%;
      height: 280px;
      margin-top: 6px;
    }

    /* Sections */
    .section {
      margin-top: 30px;
      padding: 22px 20px 26px;
      border-radius: 20px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.07);
      position: relative;
    }

    .section1 { background: #eef2ff; }
    .section2 { background: #fff5e6; }
    .section3 { background: #f2efff; }

    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title span.icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
    }

    .section-title span.icon i {
      font-size: 14px;
      color: #021640;
    }

    .section-subtitle {
      font-size: 12px;
      color: #333;
      max-width: 60%;
    }

    /* Chart grid */
    .section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
      margin-top: 10px;
    }

    .chart-card {
      background: #ffffff;
      box-shadow: var(--card-shadow);
      border-radius: 14px;
      padding: 10px 12px 8px;
      display: flex;
      flex-direction: column;
      min-height: 260px;
      border: 1px solid #e3e7f5;
    }

    .chart-card.accent-blue   { border-top: 3px solid #4572c4; }
    .chart-card.accent-orange { border-top: 3px solid #ffb347; }
    .chart-card.accent-purple { border-top: 3px solid #8e44ad; }
    .chart-card.accent-green  { border-top: 3px solid #27ae60; }

    .chart-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--primary);
    }

    .chart-caption {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }

    .chart-body {
      width: 100%;
      flex: 1;
    }

    .wide-2 { grid-column: span 2; }
    @media (max-width: 900px) { .wide-2 { grid-column: span 1; } }

    /* Chart heights */
    #chart1,#chart2,#chart3,#chart4,#chart7,#chart8,#chart10 { height: 280px; }
    #chart5 { height: 300px; }
    #chart6 { height: 340px; }
    #chart13 { height: 300px; }
    #chart9 { height: 280px; }
    #chart11,#chart12 { height: 340px; }
  </style>
</head>
<body>
  <!-- Main heading -->
  <div class="header">
    <h1>Dashboard</h1>
    <p>Key trends and business insights</p>

    <div class="top-nav">
      <button data-target="#sec1"><i class="fa-solid fa-city"></i>土瓜灣社區概況</button>
      <button data-target="#sec2"><i class="fa-solid fa-ticket"></i>消費券使用與評價</button>
      <button data-target="#sec3"><i class="fa-solid fa-people-group"></i>民社活動參與與滿意度</button>
    </div>
  </div>

  <div class="page">
    <!-- KPI cards -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-header">
          <span>受訪者總數</span>
          <i class="fa-solid fa-users"></i>
        </div>
        <div class="kpi-value" id="kpi-total-respondents">0</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span>照顧兒童的受訪者比例 (Q4)</span>
          <i class="fa-solid fa-child-reaching"></i>
        </div>
        <div class="kpi-value" id="kpi-percent-care-child">0%</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span>照顧長者的受訪者比例 (Q4)</span>
          <i class="fa-solid fa-person-cane"></i>
        </div>
        <div class="kpi-value" id="kpi-percent-care-elderly">0%</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span>多重照顧角色的受訪者比例 (Q4)</span>
          <i class="fa-solid fa-people-roof"></i>
        </div>
        <div class="kpi-value" id="kpi-percent-multi-role">0%</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-header">
          <span>最多受訪者的居住類型 (Q5)</span>
          <i class="fa-solid fa-house"></i>
        </div>
        <div class="kpi-value" id="kpi-top-housing-type">—</div>
      </div>
    </div>

    <p class="note">
      Coding assumed：Q1 年齡，Q2 性別，Q3 家庭人數，Q4 照顧對象及人數，Q5 住屋類型，Q6 家庭收入，Q8 公共設施需要，Q9 暫託服務需要，Q18 參與活動，Q19 活動滿意度，Q20 未來活動期望，Q22 消費券幫助程度，Q23 消費券用途。
    </p>

    <!-- Q4 distribution summary -->
    <div class="q4-summary">
      <div class="q4-summary-title">Q4 現時照顧家人／親屬人數結構</div>
      <div class="q4-summary-caption">
        以熱度圖 (Heatmap) 顯示在 0 名至 4 名或以上不同照顧人數下，兒童、長者及殘疾人士三類照顧對象的受訪者比例（％），顏色愈深代表比例愈高。
      </div>
      <div class="q4-chart" id="q4-chart"></div>
    </div>

    <!-- SECTION 1: 土瓜灣社區概況 -->
    <section class="section section1" id="sec1">
      <div class="section-header">
        <div class="section-title">
          <span class="icon"><i class="fa-solid fa-city"></i></span>
          <span>土瓜灣照顧者社區概況</span>
        </div>
        <div class="section-subtitle">
          描述受訪照顧者的基本背景，包括年齡、性別、家庭結構、住屋類型及家庭收入，並展示對公共設施及暫託服務的需要。
        </div>
      </div>

      <div class="section-grid">
        <div class="chart-card accent-blue">
          <div class="chart-title">受訪者年齡分佈 (Q1)</div>
          <div class="chart-caption">每條柱代表不同年齡組別的照顧者人數。</div>
          <div class="chart-body" id="chart1"></div>
        </div>

        <div class="chart-card accent-blue">
          <div class="chart-title">受訪者性別 (Q2)</div>
          <div class="chart-caption">男／女／不願透露的比例。</div>
          <div class="chart-body" id="chart2"></div>
        </div>

        <div class="chart-card accent-green">
          <div class="chart-title">照顧對象類型 (Q4)</div>
          <div class="chart-caption">以極座標圖顯示照顧兒童、長者及殘疾人士的人數。</div>
          <div class="chart-body" id="chart3"></div>
        </div>

        <div class="chart-card accent-green">
          <div class="chart-title">同時照顧的家庭成員種類數目 (Q4)</div>
          <div class="chart-caption">橫向柱圖顯示「0 至 3 種照顧角色」的人數。</div>
          <div class="chart-body" id="chart4"></div>
        </div>

        <div class="chart-card accent-blue">
          <div class="chart-title">住屋類型 (Q5)</div>
          <div class="chart-caption">反映照顧者主要居住於公屋、唐樓／私樓等的情況。</div>
          <div class="chart-body" id="chart5"></div>
        </div>

        <div class="chart-card accent-blue wide-2">
          <div class="chart-title">每月家庭入息分佈 (Q6)</div>
          <div class="chart-caption">以矩形樹圖 (Treemap) 顯示不同入息組別的戶數，格仔愈大代表愈多人。</div>
          <div class="chart-body" id="chart6"></div>
        </div>

        <div class="chart-card accent-purple">
          <div class="chart-title">最希望社區改善的公共設施 (Q8)</div>
          <div class="chart-caption">六邊型雷達圖愈外圈代表愈多照顧者選擇該項設施。</div>
          <div class="chart-body" id="chart9"></div>
        </div>

        <div class="chart-card accent-purple wide-2">
          <div class="chart-title">最有幫助的暫託服務類型 (Q9)</div>
          <div class="chart-caption">
            以扇形面積圖顯示各類暫託服務被選為「最有幫助」的人數，愈大代表愈多人需要。
          </div>
          <div class="chart-body" id="chart10"></div>
        </div>
      </div>
    </section>

    <!-- SECTION 2: 消費券 -->
    <section class="section section2" id="sec2">
      <div class="section-header">
        <div class="section-title">
          <span class="icon"><i class="fa-solid fa-ticket"></i></span>
          <span>消費券使用與照顧壓力紓緩</span>
        </div>
        <div class="section-subtitle">
          了解消費券對照顧者家庭經濟的實際幫助程度，以及主要開支項目，作為未來政策及支援方向的參考。
        </div>
      </div>

      <div class="section-grid">
        <div class="chart-card accent-orange wide-2">
          <div class="chart-title">消費券對家庭生活的幫助程度 (Q22)</div>
          <div class="chart-caption">愈左代表愈有幫助，愈右代表幫助較少。</div>
          <div class="chart-body" id="chart7"></div>
        </div>

        <div class="chart-card accent-orange wide-2">
          <div class="chart-title">消費券主要開支項目 (Q23)</div>
          <div class="chart-caption">放射型圓環圖顯示各項目所佔比例，例如日用品、食品、交通、小孩用品等。</div>
          <div class="chart-body" id="chart13"></div>
        </div>
      </div>
    </section>

    <!-- SECTION 3: 民社活動 -->
    <section class="section section3" id="sec3">
      <div class="section-header">
        <div class="section-title">
          <span class="icon"><i class="fa-solid fa-people-group"></i></span>
          <span>民社活動參與與滿意度</span>
        </div>
        <div class="section-subtitle">
          檢視照顧者對「兒童照顧者應援計劃」活動的參與情況、整體滿意度，以及對未來 PSC 活動方向的期望。
        </div>
      </div>

      <div class="section-grid">
        <div class="chart-card accent-blue wide-2">
          <div class="chart-title">曾參與的民社活動類型 (Q18)</div>
          <div class="chart-caption">顯示有參與不同活動的人數，例如喘息活動、分享會、小店探索隊、義工團等。</div>
          <div class="chart-body" id="chart8"></div>
        </div>

        <div class="chart-card accent-purple">
          <div class="chart-title">對民社活動整體滿意度 (Q19)</div>
          <div class="chart-caption">六邊型雷達圖中愈外圈代表平均滿意度愈高。</div>
          <div class="chart-body" id="chart11"></div>
        </div>

        <div class="chart-card accent-green">
          <div class="chart-title">未來最期望 PSC 舉辦的活動類型 (Q20)</div>
          <div class="chart-caption">雷達圖顯示照顧者對親子休閒、身心健康工作坊、照顧技巧訓練等不同方向的需求強度。</div>
          <div class="chart-body" id="chart12"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const COLOR_PRIMARY = '#021640';
    const COLOR_2 = '#0066cc';
    const COLOR_3 = '#0099cc';
    const COLOR_4 = '#4572c4';
    const COLOR_5 = '#558ed5';
    const COLOR_6 = '#1f4e79';

    const AGE_LABELS = {
      '1': '18歲以下',
      '2': '18–29歲',
      '3': '30–39歲',
      '4': '40–49歲',
      '5': '50–59歲',
      '6': '60歲或以上'
    };

    const GENDER_LABELS = {
      '1': '男',
      '2': '女',
      '3': '不願透露'
    };

    const HOUSING_LABELS = {
      '1': '唐樓／私樓 (非天台)',
      '2': '天台分間單位',
      '3': '宿舍／劏房',
      '4': '半地下劏房',
      '5': '公屋',
      '6': '中轉屋',
      '7': '其他／未列明'
    };

    const INCOME_LABELS = {
      '1': '$5,000 以下',
      '2': '$5,000 – < $10,000',
      '3': '$10,000 – < $15,000',
      '4': '$15,000 – < $20,000',
      '5': '$20,000 – < $25,000',
      '6': '$25,000 – < $30,000',
      '7': '$30,000 或以上',
      '8': '不願回答'
    };

    const VOUCHER_HELP_LABELS = {
      '1': '非常有幫助',
      '2': '頗有幫助',
      '3': '一般',
      '4': '幫助不大',
      '5': '完全沒有幫助'
    };

    const Q18_LABELS = {
      Q18_Respite: '喘息活動',
      Q18_Sharing: '社區分享會',
      Q18_DadGroup: '爸爸小組',
      Q18_Explore: '小店探索隊',
      Q18_Volunteer: '義工團',
      Q18_Voucher: '消費券',
      Q18_Other: '其他活動',
      Q18_None: '沒有參加民社活動'
    };

    const Q8_ITEMS = [
      { key: 'Q8_Parks',       label: '公園及康樂設施' },
      { key: 'Q8_BarrierFree', label: '無障礙通道及設施' },
      { key: 'Q8_BabyToilet',  label: '親子洗手間' },
      { key: 'Q8_RestSpace',   label: '社區休息空間' },
      { key: 'Q8_Lockers',     label: '儲物櫃／掛鉤等便利設施' },
      { key: 'Q8_Other_Text',  label: '其他建議', isText: true }
    ];

    const Q9_ITEMS = [
      { key: 'Q9_AfterSchool', label: '課餘託管服務' },
      { key: 'Q9_Holiday',     label: '假日託管／短暫託管' },
      { key: 'Q9_Emergency',   label: '緊急照顧服務' },
      { key: 'Q9_Night',       label: '夜間照顧服務' },
      { key: 'Q9_Hotline',     label: '資訊熱線及即時支援' },
      { key: 'Q9_Other_Text',  label: '其他暫託安排', isText: true }
    ];

    const Q19_ITEMS = [
      { key: 'Q19_Respite_Sat',   label: '喘息活動' },
      { key: 'Q19_Sharing_Sat',   label: '社區分享會' },
      { key: 'Q19_DadGroup_Sat',  label: '爸爸小組' },
      { key: 'Q19_Explore_Sat',   label: '小店探索隊' },
      { key: 'Q19_Volunteer_Sat', label: '義工團' },
      { key: 'Q19_Voucher_Sat',   label: '消費券活動' },
      { key: 'Q19_Other_Sat',     label: '其他活動' }
    ];

    const Q20_ITEMS = [
      { key: 'Q20_ParentChild', label: '親子休閒' },
      { key: 'Q20_Recreation',  label: '康樂活動' },
      { key: 'Q20_Health',      label: '身心健康工作坊' },
      { key: 'Q20_Emotion',     label: '情緒管理工作坊' },
      { key: 'Q20_Skills',      label: '照顧技巧培訓' },
      { key: 'Q20_Sharing',     label: '知識分享／經驗交流小組' },
      { key: 'Q20_Resources',   label: '資源配對及協助' },
      { key: 'Q20_Volunteer',   label: '社區服務參與（如義工活動）' },
      { key: 'Q20_Other_Text',  label: '其他活動構想', isText: true }
    ];

    const Q23_ITEMS = [
      { key: 'Q23_DailyGoods',    label: '日用品' },
      { key: 'Q23_Food',          label: '食品' },
      { key: 'Q23_Transport',     label: '交通' },
      { key: 'Q23_FamilyGoods',   label: '家庭／小孩用品' },
      { key: 'Q23_Medical',       label: '醫療／護理用品' },
      { key: 'Q23_Entertainment', label: '娛樂休閒' },
      { key: 'Q23_Counseling',    label: '輔導／支援服務' }
    ];

    function mapLabel(map, code) {
      const k = String(code || '').trim();
      return map[k] || '未填寫';
    }

    document.addEventListener('DOMContentLoaded', () => {
      // smooth scroll
      document.querySelectorAll('.top-nav button').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.querySelector(btn.dataset.target);
          if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });

      fetch('data.xlsx')
        .then(res => res.arrayBuffer())
        .then(ab => {
          const wb = XLSX.read(ab, { type: 'array' });
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
          const rows = json.filter(r =>
            r.Respondent_ID !== undefined &&
            r.Respondent_ID !== null &&
            String(r.Respondent_ID).trim() !== ""
          );
          buildDashboard(rows);
        })
        .catch(err => console.error('Error loading data.xlsx:', err));
    });

    function toNumber(val) {
      if (val === undefined || val === null || val === '') return 0;
      const num = Number(val);
      return isNaN(num) ? 0 : num;
    }

    function buildDashboard(data) {
      if (!data || data.length === 0) return;

      const total = data.length;

      const careChildCount   = data.filter(r => toNumber(r.Q4_Care_Child)   > 0).length;
      const careElderlyCount = data.filter(r => toNumber(r.Q4_Care_Elderly) > 0).length;
      const careDisabledCount= data.filter(r => toNumber(r.Q4_Care_Disabled)> 0).length;

      const careChildPercent   = total > 0 ? (careChildCount   / total) * 100 : 0;
      const careElderlyPercent = total > 0 ? (careElderlyCount / total) * 100 : 0;

      let multiRoleCount = 0;
      const rolesPerPersonCounts = { 0: 0, 1: 0, 2: 0, 3: 0 };
      data.forEach(r => {
        const roles =
          toNumber(r.Q4_Care_Child) +
          toNumber(r.Q4_Care_Elderly) +
          toNumber(r.Q4_Care_Disabled);
        if (rolesPerPersonCounts[roles] === undefined) {
          rolesPerPersonCounts[roles] = 0;
        }
        rolesPerPersonCounts[roles]++;
        if (roles >= 2) multiRoleCount++;
      });
      const multiRolePercent = total > 0 ? (multiRoleCount / total) * 100 : 0;

      function countByField(fieldName) {
        const map = {};
        data.forEach(r => {
          const key = String(r[fieldName] || '').trim();
          if (!key) return;
          if (!map[key]) map[key] = 0;
          map[key]++;
        });
        const keys = Object.keys(map).sort((a, b) => Number(a) - Number(b));
        const counts = keys.map(k => map[k]);
        return { keys, counts };
      }

      const ageInfo         = countByField('Q1_Age');
      const genderInfo      = countByField('Q2_Gender');
      const housingInfo     = countByField('Q5_Housing_Type');
      const incomeInfo      = countByField('Q6_Income');
      const voucherHelpInfo = countByField('Q22_Voucher_Help');

      // Top housing type (for KPI)
      let topHousingLabel = '—';
      if (housingInfo.keys.length > 0) {
        let maxIndex = 0;
        for (let i = 1; i < housingInfo.counts.length; i++) {
          if (housingInfo.counts[i] > housingInfo.counts[maxIndex]) {
            maxIndex = i;
          }
        }
        const topKey = housingInfo.keys[maxIndex];
        topHousingLabel = mapLabel(HOUSING_LABELS, topKey);
      }

      // Update KPI DOM
      document.getElementById('kpi-total-respondents').textContent = total;
      document.getElementById('kpi-percent-care-child').textContent   = careChildPercent.toFixed(1) + '%';
      document.getElementById('kpi-percent-care-elderly').textContent = careElderlyPercent.toFixed(1) + '%';
      document.getElementById('kpi-percent-multi-role').textContent   = multiRolePercent.toFixed(1) + '%';
      document.getElementById('kpi-top-housing-type').textContent     = topHousingLabel;

      /* ----- Q4: 0–4名分佈（percentage，用 heatmap） ----- */
      function q4Dist(fieldName) {
        const counts = [0, 0, 0, 0, 0]; // 0–4
        let validTotal = 0;
        data.forEach(r => {
          const v = toNumber(r[fieldName]);
          if (v >= 0 && v <= 4) {
            counts[v]++;
            validTotal++;
          }
        });
        const perc = counts.map(c => validTotal > 0 ? (c * 100 / validTotal) : 0);
        return { counts, perc, total: validTotal };
      }

      const distChild   = q4Dist('Q4_Care_Child');
      const distElderly = q4Dist('Q4_Care_Elderly');
      const distDisabled= q4Dist('Q4_Care_Disabled');

      const q4Categories = ['0 名', '1 名', '2 名', '3 名', '4 名或以上'];

      const q4HeatmapSeries = [
        {
          name: '照顧兒童',
          data: q4Categories.map((lbl, idx) => ({
            x: lbl,
            y: Number(distChild.perc[idx].toFixed(1))
          }))
        },
        {
          name: '照顧長者',
          data: q4Categories.map((lbl, idx) => ({
            x: lbl,
            y: Number(distElderly.perc[idx].toFixed(1))
          }))
        },
        {
          name: '照顧殘疾人士',
          data: q4Categories.map((lbl, idx) => ({
            x: lbl,
            y: Number(distDisabled.perc[idx].toFixed(1))
          }))
        }
      ];

      // Q18 participation
      const caringCounts = {
        'Child':    careChildCount,
        'Elderly':  careElderlyCount,
        'Disabled': careDisabledCount
      };
      const roleLabels = Object.keys(rolesPerPersonCounts).sort((a,b)=>Number(a)-Number(b));
      const roleSeries = roleLabels.map(k => rolesPerPersonCounts[k]);

      const q18Labels = [];
      const q18Counts = [];
      [
        'Q18_Respite',
        'Q18_Sharing',
        'Q18_DadGroup',
        'Q18_Explore',
        'Q18_Volunteer',
        'Q18_Voucher',
        'Q18_Other',
        'Q18_None'
      ].forEach(key => {
        let c = 0;
        data.forEach(r => { if (toNumber(r[key]) > 0) c++; });
        q18Labels.push(Q18_LABELS[key] || key);
        q18Counts.push(c);
      });

      const q8Labels = [];
      const q8Counts = [];
      Q8_ITEMS.forEach(item => {
        let c = 0;
        data.forEach(r => {
          if (item.isText) {
            if (String(r[item.key] || '').trim() !== '') c++;
          } else if (toNumber(r[item.key]) > 0) {
            c++;
          }
        });
        q8Labels.push(item.label);
        q8Counts.push(c);
      });

      const q9Labels = [];
      const q9Counts = [];
      Q9_ITEMS.forEach(item => {
        let c = 0;
        data.forEach(r => {
          if (item.isText) {
            if (String(r[item.key] || '').trim() !== '') c++;
          } else if (toNumber(r[item.key]) > 0) {
            c++;
          }
        });
        q9Labels.push(item.label);
        q9Counts.push(c);
      });

      const q19Labels = [];
      const q19Scores = [];
      Q19_ITEMS.forEach(item => {
        let sum = 0, n = 0;
        data.forEach(r => {
          const v = toNumber(r[item.key]);
          if (v > 0) { sum += v; n++; }
        });
        let score = 0;
        if (n > 0) {
          const avg = sum / n;   // 1=非常滿意,5=非常不滿意
          score = 6 - avg;       // 轉成 1–5，愈高愈滿意
        }
        q19Labels.push(item.label);
        q19Scores.push(score);
      });

      const q20Labels = [];
      const q20Counts = [];
      Q20_ITEMS.forEach(item => {
        let c = 0;
        data.forEach(r => {
          if (item.isText) {
            if (String(r[item.key] || '').trim() !== '') c++;
          } else if (toNumber(r[item.key]) > 0) {
            c++;
          }
        });
        q20Labels.push(item.label);
        q20Counts.push(c);
      });

      const q23Labels = [];
      const q23Counts = [];
      Q23_ITEMS.forEach(item => {
        let c = 0;
        data.forEach(r => { if (toNumber(r[item.key]) > 0) c++; });
        q23Labels.push(item.label);
        q23Counts.push(c);
      });

      renderCharts({
        ageInfo,
        genderInfo,
        q4Categories,
        q4HeatmapSeries,
        caringCounts,
        roleLabels,
        roleSeries,
        housingInfo,
        incomeInfo,
        voucherHelpInfo,
        q18Labels,
        q18Counts,
        q8Labels,
        q8Counts,
        q9Labels,
        q9Counts,
        q19Labels,
        q19Scores,
        q20Labels,
        q20Counts,
        q23Labels,
        q23Counts
      });
    }

    function renderCharts(d) {
      /* ----- Q4：照顧人數結構（Heatmap） ----- */
      new ApexCharts(document.querySelector("#q4-chart"), {
        chart: { type: 'heatmap', height: 260, toolbar: { show: false } },
        series: d.q4HeatmapSeries,
        dataLabels: {
          enabled: true,
          style: { fontSize: '11px', colors: ['#ffffff'] },
          formatter: val => val.toFixed(0) + '%'
        },
        xaxis: {
          type: 'category',
          categories: d.q4Categories,
          title: { text: '照顧人數', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        yaxis: {
          title: { text: '照顧對象', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: [COLOR_PRIMARY, COLOR_PRIMARY, COLOR_PRIMARY], fontSize: '11px' } }
        },
        plotOptions: {
          heatmap: {
            shadeIntensity: 0.7,
            colorScale: {
              ranges: [
                { from: 0,  to: 10, color: '#e1ecff', name: '0–10%' },
                { from: 10, to: 30, color: '#9ec5ff', name: '10–30%' },
                { from: 30, to: 60, color: '#5a8dee', name: '30–60%' },
                { from: 60, to: 100, color: '#1f4e79', name: '60% 以上' }
              ]
            }
          }
        },
        legend: {
          position: 'right',
          labels: { colors: COLOR_PRIMARY }
        },
        tooltip: {
          y: { formatter: val => val.toFixed(1) + '% 受訪者' }
        }
      }).render();

      /* ----- 1 Age (bar) ----- */
      new ApexCharts(document.querySelector("#chart1"), {
        chart: { type: 'bar', height: 280, toolbar: { show: false } },
        series: [{ name: '受訪者人數', data: d.ageInfo.counts }],
        xaxis: {
          title: { text: '年齡組別', style: { color: COLOR_PRIMARY } },
          categories: d.ageInfo.keys.map(k => mapLabel(AGE_LABELS, k)),
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        yaxis: {
          title: { text: '人數', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        plotOptions: { bar: { columnWidth: '55%', borderRadius: 6 } },
        colors: [COLOR_PRIMARY],
        dataLabels: { enabled: false }
      }).render();

      /* ----- 2 Gender (donut) ----- */
      new ApexCharts(document.querySelector("#chart2"), {
        chart: { type: 'donut', height: 280 },
        series: d.genderInfo.counts,
        labels: d.genderInfo.keys.map(k => mapLabel(GENDER_LABELS, k)),
        colors: [COLOR_PRIMARY, COLOR_2, COLOR_3],
        legend: { position: 'bottom', labels: { colors: COLOR_PRIMARY } },
        dataLabels: { enabled: true, formatter: val => val.toFixed(1) + '%' }
      }).render();

      /* ----- 3 Caring roles (polar area) ----- */
      new ApexCharts(document.querySelector("#chart3"), {
        chart: { type: 'polarArea', height: 280 },
        series: ['Child', 'Elderly', 'Disabled'].map(k => d.caringCounts[k]),
        labels: ['照顧兒童', '照顧長者', '照顧殘疾人士'],
        colors: [COLOR_2, COLOR_3, COLOR_4],
        stroke: { width: 1 },
        legend: { position: 'bottom', labels: { colors: COLOR_PRIMARY } },
        dataLabels: { enabled: false },
        yaxis: { show: false }
      }).render();

      /* ----- 4 Roles per respondent (horizontal bar) ----- */
      new ApexCharts(document.querySelector("#chart4"), {
        chart: { type: 'bar', height: 280, toolbar: { show: false } },
        series: [{ name: '受訪者人數', data: d.roleSeries }],
        xaxis: {
          title: { text: '人數', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        yaxis: {
          title: { text: '同時照顧的對象數目', style: { color: COLOR_PRIMARY } },
          categories: d.roleLabels.map(k => `${k} 種`),
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        plotOptions: { bar: { horizontal: true, barHeight: '50%', borderRadius: 6 } },
        colors: [COLOR_3],
        dataLabels: { enabled: false }
      }).render();

      /* ----- 5 Housing (horizontal ranking bar) ----- */
      new ApexCharts(document.querySelector("#chart5"), {
        chart: { type: 'bar', height: 300, toolbar: { show: false } },
        series: [{ name: '戶數', data: d.housingInfo.counts }],
        xaxis: {
          title: { text: '戶數', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        yaxis: {
          title: { text: '住屋類型', style: { color: COLOR_PRIMARY } },
          categories: d.housingInfo.keys.map(k => mapLabel(HOUSING_LABELS, k)),
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        plotOptions: {
          bar: {
            horizontal: true,
            barHeight: '55%',
            borderRadius: 6
          }
        },
        colors: [COLOR_4],
        dataLabels: {
          enabled: true,
          formatter: val => val + ' 戶',
          style: { fontSize: '11px' }
        },
        tooltip: {
          y: { formatter: val => val + ' 戶' }
        }
      }).render();

      /* ----- 6 Income (treemap) ----- */
      new ApexCharts(document.querySelector("#chart6"), {
        chart: { type: 'treemap', height: 340, toolbar: { show: false } },
        series: [{
          data: d.incomeInfo.keys.map((k, idx) => ({
            x: mapLabel(INCOME_LABELS, k),
            y: d.incomeInfo.counts[idx]
          }))
        }],
        dataLabels: {
          enabled: true,
          style: { fontSize: '11px', colors: ['#fff'] },
          formatter: function (text, opt) {
            const value = opt.value;
            return text + '\n(' + value + ' 戶)';
          }
        },
        colors: [COLOR_5, COLOR_2, COLOR_3, COLOR_4, COLOR_6, COLOR_PRIMARY, '#8e44ad', '#27ae60']
      }).render();

      /* ----- 7 Voucher help (horizontal bar) ----- */
      new ApexCharts(document.querySelector("#chart7"), {
        chart: { type: 'bar', height: 280, toolbar: { show: false } },
        series: [{ name: '受訪者人數', data: d.voucherHelpInfo.counts }],
        xaxis: {
          title: { text: '人數', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        yaxis: {
          title: { text: '消費券幫助程度', style: { color: COLOR_PRIMARY } },
          categories: d.voucherHelpInfo.keys.map(k => {
            const label = mapLabel(VOUCHER_HELP_LABELS, k);
            return `${label} (${k})`;
          }),
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        plotOptions: { bar: { horizontal: true, barHeight: '55%', borderRadius: 6 } },
        colors: ['#ff7a8a'],
        dataLabels: { enabled: false }
      }).render();

      /* ----- 8 Q18 participation ----- */
      new ApexCharts(document.querySelector("#chart8"), {
        chart: { type: 'bar', height: 280, toolbar: { show: false } },
        series: [{ name: '有參與人數', data: d.q18Counts }],
        xaxis: {
          title: { text: '活動類型', style: { color: COLOR_PRIMARY } },
          categories: d.q18Labels,
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' }, rotate: -20 }
        },
        yaxis: {
          title: { text: '人數', style: { color: COLOR_PRIMARY } },
          labels: { style: { colors: COLOR_PRIMARY, fontSize: '11px' } }
        },
        plotOptions: { bar: { columnWidth: '55%', distributed: true, borderRadius: 6 } },
        colors: [COLOR_PRIMARY, COLOR_2, COLOR_3, COLOR_4, COLOR_5, COLOR_6, '#8e44ad', '#27ae60'],
        dataLabels: { enabled: false },
        tooltip: { y: { formatter: v => `${v} 名受訪者` } }
      }).render();

      /* ----- 9 Q8 facilities (radar) ----- */
      new ApexCharts(document.querySelector("#chart9"), {
        chart: { type: 'radar', height: 280, toolbar: { show: false } },
        series: [{ name: '選擇人數', data: d.q8Counts }],
        labels: d.q8Labels,
        colors: [COLOR_PRIMARY],
        yaxis: {
          labels: { style: { colors: [COLOR_PRIMARY], fontSize: '10px' } },
          tickAmount: 5
        },
        stroke: { width: 2 },
        fill: { opacity: 0.25 },
        markers: { size: 3 }
      }).render();

      /* ----- 10 Q9 respite services (polar area) ----- */
      new ApexCharts(document.querySelector("#chart10"), {
        chart: { type: 'polarArea', height: 320, toolbar: { show: false } },
        series: d.q9Counts,
        labels: d.q9Labels,
        stroke: { width: 1 },
        colors: [COLOR_4, COLOR_2, COLOR_3, COLOR_5, COLOR_6, '#27ae60'],
        fill: { opacity: 0.85 },
        legend: {
          position: 'right',
          labels: { colors: COLOR_PRIMARY }
        },
        dataLabels: {
          enabled: true,
          formatter: (val, opts) => {
            const count = d.q9Counts[opts.seriesIndex];
            return count + ' 人';
          },
          style: { fontSize: '11px' }
        },
        yaxis: {
          labels: { show: false }
        },
        tooltip: {
          y: {
            formatter: (val, opts) => {
              const count = d.q9Counts[opts.seriesIndex];
              return count + ' 名受訪者';
            }
          }
        }
      }).render();

      /* ----- 11 Q19 satisfaction (radar) ----- */
      new ApexCharts(document.querySelector("#chart11"), {
        chart: { type: 'radar', height: 340, toolbar: { show: false } },
        series: [{ name: '平均滿意度（愈高愈滿意）', data: d.q19Scores }],
        labels: d.q19Labels,
        colors: ['#8e44ad'],
        yaxis: {
          min: 0,
          max: 5,
          tickAmount: 5,
          labels: { style: { colors: [COLOR_PRIMARY], fontSize: '10px' } }
        },
        stroke: { width: 2 },
        fill: { opacity: 0.25 },
        markers: { size: 3 }
      }).render();

      /* ----- 12 Q20 future activities (radar) ----- */
      new ApexCharts(document.querySelector("#chart12"), {
        chart: { type: 'radar', height: 340, toolbar: { show: false } },
        series: [{ name: '有興趣人數', data: d.q20Counts }],
        labels: d.q20Labels,
        colors: [COLOR_4],
        yaxis: {
          labels: { style: { colors: [COLOR_PRIMARY], fontSize: '10px' } },
          tickAmount: 5
        },
        stroke: { width: 2 },
        fill: { opacity: 0.25 },
        markers: { size: 3 },
        tooltip: { y: { formatter: v => `${v} 名受訪者` } }
      }).render();

      /* ----- 13 Q23 spending (radial bar) ----- */
      new ApexCharts(document.querySelector("#chart13"), {
        chart: { type: 'radialBar', height: 300 },
        series: d.q23Counts,
        labels: d.q23Labels,
        colors: ['#ffb347', '#ff7a8a', '#0066cc', '#27ae60', '#8e44ad', '#558ed5', '#1f4e79'],
        plotOptions: {
          radialBar: {
            offsetY: 0,
            dataLabels: {
              name: { fontSize: '12px' },
              value: { fontSize: '12px', formatter: v => Math.round(v) + ' 人' },
              total: {
                show: true,
                label: '合計',
                formatter: () => {
                  const sum = d.q23Counts.reduce((a, b) => a + b, 0);
                  return sum + ' 人次';
                }
              }
            }
          }
        },
        legend: {
          show: true,
          position: 'right',
          labels: { colors: COLOR_PRIMARY },
          formatter: (seriesName, opts) => {
            const val = opts.w.globals.series[opts.seriesIndex];
            return seriesName + '：' + val + ' 人';
          }
        }
      }).render();
    }
  </script>
</body>
</html>
